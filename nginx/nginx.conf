worker_processes  auto;

events {
  worker_connections  1024;
}

http {
  # Logs en formato JSON (útil para observabilidad)
  log_format json_combined escape=json
    '{ "time":"$time_iso8601", "remote_addr":"$remote_addr", '
    '"request":"$request", "status":$status, "body_bytes_sent":$body_bytes_sent, '
    '"request_time":$request_time, "upstream_response_time":"$upstream_response_time", '
    '"upstream_addr":"$upstream_addr", "http_referer":"$http_referer", "http_user_agent":"$http_user_agent" }';
  access_log /var/log/nginx/access.log json_combined;
  error_log  /var/log/nginx/error.log warn;

  # Buenas prácticas HTTP
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;
  types_hash_max_size 2048;

  # Seguridad básica
  server_tokens off;

  # Compresión
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_types
    text/plain
    text/css
    application/json
    application/javascript
    application/xml
    text/javascript
    image/svg+xml;

  # Timeouts y buffers de proxy
  proxy_connect_timeout   5s;
  proxy_send_timeout      60s;
  proxy_read_timeout      60s;
  proxy_buffering         on;
  proxy_buffers           16 16k;
  proxy_busy_buffers_size 24k;

  # Headers de proxy
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Upstreams internos
  upstream django_upstream {
    server web:8000;
    keepalive 32;
  }
  upstream grafana_upstream { server grafana:3000; }
  upstream prom_upstream    { server prometheus:9090; }
  upstream alert_upstream   { server alertmanager:9093; }

  # Servidor público (HTTP). Si habilitas TLS, redirige 80 -> 443 y añade server 443 ssl http2
  server {listen 80;
    server_name _;

    # Health del proxy (útil para k8s o checks externos)
    location /nginx-health {
      add_header Content-Type text/plain;
      return 200 'ok';
    }

    # Bloquear acceso público a métricas de Django (Prometheus scrapea internamente)
    location = /metrics { deny all; }
    location = /metrics/ { deny all; }
    location = /metrics/influx { deny all; }
    location = /metrics/influx/ { deny all; }

    # Grafana bajo subpath /grafana
    # Grafana ya recibe GF_SERVER_ROOT_URL y SERVE_FROM_SUB_PATH=true
    location /grafana/ {
      proxy_pass http://grafana_upstream/;
      proxy_set_header Host $host;
    }

    # Prometheus UI bajo /prometheus (con flags external-url/route-prefix)
    location /prometheus/ {
      proxy_pass http://prom_upstream/;
    }

    # Alertmanager UI bajo /alertmanager (con flag external-url)
    location /alertmanager/ {
      proxy_pass http://alert_upstream/;
    }

    # Opcional: servir estáticos si los montas en Nginx (ahora WhiteNoise ya sirve en Django)
    # location /static/ {
    #   alias /static/;  # monta volumen con staticfiles colectados
    #   expires 7d;
    #   add_header Cache-Control "public, max-age=604800, immutable";
    # }

    # Tráfico por defecto a Django (Gunicorn)
    location /django/ {
      client_max_body_size 10m;
      proxy_pass http://web:8000/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Script-Name /django;
    }

    # Buenas cabeceras de seguridad (ajusta según tus necesidades)
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; # solo si usas TLS
  }
}